<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Drake: Python Bindings</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Drake
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__python__bindings.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Python Bindings<div class="ingroups"><a class="el" href="group__technical__notes.html">Technical Notes</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>Details on implementing python bindings for the C++ code. </p>
<h1>Overview</h1>
<p>Drake uses <a href="http://pybind11.readthedocs.io/en/stable/">pybind11</a> for binding its C++ API to Python.</p>
<p>At present, a fork of <code><a class="el" href="namespacepybind11.html">pybind11</a></code> is used which permits bindings matrices with <code>dtype=object</code>, passing <code>unique_ptr</code> objects, and prevents aliasing for Python classes derived from <code><a class="el" href="namespacepybind11.html">pybind11</a></code> classes.</p>
<h2>Module Organization</h2>
<p>The structure of the bindings generally follow the <em>directory structure</em>, not the namespace structure. As an example, if in C++ you do: </p><pre class="fragment">#include &lt;drake/multibody/multibody_tree/multibody_plant/{header}.h&gt;
using drake::multibody::multibody_plant::{symbol};
</pre><p>then in Python you would do: </p><pre class="fragment">from pydrake.multibody.multibody_tree.multibody_plant import {symbol}
</pre><p>Some (but not all) exceptions:</p>
<ul>
<li>Some of <code>drake/common</code> is incorporated into <code>pydrake.util</code>. (This will be remedied in the future.)</li>
<li><code>drake/multibody/rigid_body_tree.h</code> is actually contained in the module <code>pydrake.multibody.rigid_body_tree</code>.</li>
<li><code><a class="el" href="mathematical__program_8h.html">drake/solvers/mathematical_program.h</a></code> is actually contained in the module <code>pydrake.solvers.mathematicalprogram</code>.</li>
</ul>
<h2><code><a class="el" href="namespacepybind11.html">pybind11</a></code> Tips</h2>
<h3>Python Types</h3>
<p>Throughout the Drake code, Python types provided by <code><a class="el" href="namespacepybind11.html">pybind11</a></code> are used, such as <code>py::handle</code>, <code>py::object</code>, <code>py::module</code>, <code>py::str</code>, <code>py::list</code>, etc. For an overview, see the <a href="http://pybind11.readthedocs.io/en/stable/reference.html">pybind11 reference</a>.</p>
<p>All of these are effectively thin wrappers around <code>PyObject*</code>, and thus can be cheaply copied.</p>
<p>Mutating the referred-to object also does not require passing by reference, so you can always pass the object by value for functions, but you should document your method if it mutates the object in a non-obvious fashion.</p>
<h3>Python Type Conversions</h3>
<p>You can implicit convert between <code>py::object</code> and its derived classes (such as <code>py::list</code>, <code>py::class_</code>, etc.), assuming the actual Python types agree. You may also implicitly convert from <code>py::object</code> (and its derived classes) to <code>py::handle</code>.</p>
<p>If you wish to convert a <code>py::handle</code> (or <code>PyObject*</code>) to <code>py::object</code> or a derived class, you should use <a href="http://pybind11.readthedocs.io/en/stable/reference.html#_CPPv218reinterpret_borrow6handle"><code>py::reinterpret_borrow&lt;&gt;</code></a>.</p>
<h1>Conventions</h1>
<h2>API Names</h2>
<p>Any Python bindings of C++ code will maintain C++ naming conventions, as well as Python code that is directly related to C++ symbols (e.g. shims, wrappers, or extensions on existing bound classes).</p>
<p>All other Python code be Pythonic and use PEP 8 naming conventions.</p>
<h2>Target Conventions</h2>
<h3>Names</h3>
<ul>
<li><code>*_py</code>: A Python library (can be pure Python or pybind)<ul>
<li>File Names: <code>*.py</code>, <code>*_py.cc</code></li>
</ul>
</li>
<li><code>*_pybind</code>: A C++ library for adding pybind-specific utilities to be consumed by C++.<ul>
<li>File Names: <code>*_pybind.{h,cc}</code></li>
</ul>
</li>
</ul>
<p>File names should follow form with their respective target.</p>
<h3>Visibility</h3>
<ul>
<li>All Python libraries should generally be private, as <code>pydrake</code> will be consumed as one encapsulated target.</li>
<li>All C++ <code>*_pybind</code> libraries for binding utilities should be public to aide downstream Bazel projects. If the API is unstable, consider making it private with a TODO to make public once it stabilizes.</li>
</ul>
<h3>Bazel</h3>
<p>Given that <code>libdrake.so</code> relies on static linking for components, any common headers should be robust against ODR violations. This can be normally achieved by using header-only libraries.</p>
<p>For upstream dependencies of these libraries, do NOT depend on the direct targets (e.g. <code>//common:essential</code>), because this will introduce runtime ODR violations for objects that have static storage (UID counters, etc.).</p>
<p>Instead, you must temporarily violate IWYU because it will be satisfied by <code>drake_pybind_library</code>, which will incorporate <code>libdrake.so</code> and the transitive headers.</p>
<p>If singletons are required (e.g. for <code>util/cpp_param_pybind</code>), consider storing the singleton values using Python.</p>
<p>If you are developing bindings for a small portion of Drake and would like to avoid rebuilding a large number of components when testing, consider editing <code>//tools/install/libdrake:build_components.bzl</code> to reduce the number of components being built.</p>
<h2>pybind Module Definitions</h2>
<ul>
<li>Any Drake pybind module should include this header file, <code><a class="el" href="pydrake__pybind_8h.html">pydrake_pybind.h</a></code>.</li>
<li><code>PYBIND_MODULE</code> should be used to define modules.</li>
<li>Modules should be defined within the namespace <code><a class="el" href="namespacedrake_1_1pydrake.html">drake::pydrake</a></code>.</li>
<li>The alias <code>namespace py = <a class="el" href="namespacepybind11.html">pybind11</a></code> is defined as <code>drake::pydrake::py</code>. Drake modules should not re-define this alias at global scope.</li>
<li>If a certain namespace is being bound (e.g. <code><a class="el" href="namespacedrake_1_1systems_1_1sensors.html">drake::systems::sensors</a></code>), you may use <code>using namespace <a class="el" href="namespacedrake_1_1systems_1_1sensors.html">drake::systems::sensors</a></code> within functions or anonymous namespaces. Avoid <code>using namespace</code> directives otherwise.</li>
</ul>
<p><a class="anchor" id="PydrakeDoc"></a></p><h2>Documentation</h2>
<p>Drake uses a modified version of <code>mkdoc.py</code> from <code><a class="el" href="namespacepybind11.html">pybind11</a></code>, where <code>libclang</code> Python bindings are used to generate C++ docstrings accessible to the C++ binding code.</p>
<p>An example of incorporating docstrings: </p><pre class="fragment">#include "drake/bindings/pydrake/documentation_pybind.h"

PYBIND11_MODULE(math, m) {
  using namespace drake::math;
  constexpr auto&amp; doc = pydrake_doc.drake.math;
  using T = double;
  py::class_&lt;RigidTransform&lt;T&gt;&gt;(m, "RigidTransform", doc.RigidTransform.doc)
      .def(py::init(), doc.ExampleClass.ctor.doc_0args)
      ...
      .def(py::init&lt;const RotationMatrix&lt;T&gt;&amp;&gt;(), py::arg("R"),
           doc.RigidTransform.ctor.doc_1args)
      ...
      .def("set_rotation", &amp;RigidTransform&lt;T&gt;::set_rotation, py::arg("R"),
           doc.RigidTransform.set_rotation.doc)
  ...
}
</pre><p>To view the documentation rendered in Sphinx: </p><pre class="fragment">bazel run //bindings/pydrake/doc:serve_sphinx [-- --browser=false]
</pre><dl class="section note"><dt>Note</dt><dd>Drake's online Python documentation is generated on Ubuntu Bionic, and it is suggested to preview documentation using this platform. Other platforms may have slightly different generated documentation.</dd></dl>
<p>To see what indices are present, generate and open the docstring header: </p><pre class="fragment">bazel build //bindings/pydrake:generate_pybind_documentation_header
$EDITOR bazel-genfiles/bindings/pydrake/documentation_pybind.h
</pre><p>You can search for the symbol you want, e.g. <code><a class="el" href="classdrake_1_1math_1_1_rigid_transform.html#a8bedd8c483aaf5bc48587d10d7a3d485">drake::math::RigidTransform::RigidTransform</a>&lt;T&gt;</code>, and view the include file and line corresponding to the symbol that the docstring was pulled from.</p>
<dl class="section note"><dt>Note</dt><dd>This file may be large, on the order of ~100K lines; be sure to use an efficient editor!</dd></dl>
<p>For more detail:</p>
<ul>
<li>Each docstring is stored in <code>documentation_pybind.h</code> in the nested structure <code>pydrake_doc</code>.</li>
<li>The docstring for a symbol without any overloads will be accessible via <code>pydrake_doc.drake.{namespace...}.{symbol}.doc</code>.</li>
<li>The docstring for an overloaded symbol will be <code>.doc_something</code> instead of just <code>.doc</code>, where the <code>_something</code> suffix conveys some information about the overload. Browse the documentation_pybind.h (described above) for details.</li>
<li>Constructors are accessible as <code>{symbol}.ctor.doc</code>, <code>{symbol}.ctor.doc_2</code>, etc.</li>
</ul>
<p><a class="anchor" id="PydrakeKeepAlive"></a></p><h2>Keep Alive Behavior</h2>
<p><code>py::keep_alive</code> is used heavily throughout this code. For more information, please see <a href="http://pybind11.readthedocs.io/en/stable/advanced/functions.html#keep-alive">the pybind11 documentation</a>.</p>
<p>Terse notes are added to method bindings to indicate the patient (object being kept alive by nurse) and the nurse (object keeping patient alive). To expand on them:</p><ul>
<li>"Keep alive, ownership" implies that one argument is owned directly by one of the other arguments (<code>self</code> is included in those arguments, for <code>py::init&lt;&gt;</code> and class methods).</li>
<li>"Keep alive, reference" implies a reference that is lifetime-sensitive (something that is not necessarily owned by the other arguments).</li>
<li>"Keep alive, transitive" implies a transfer of ownership of owned objects from one container to another (e.g. transferring all <code>System</code>s from <code>DiagramBuilder</code> to <code>Diagram</code> when calling <code><a class="el" href="classdrake_1_1systems_1_1_diagram_builder.html#aa4aef2b1fed54592b99071ee8df81f76" title="Builds the Diagram that has been described by the calls to Connect, ExportInput, and ExportOutput...">DiagramBuilder.Build()</a></code>).</li>
</ul>
<p><a class="anchor" id="PydrakeOverloads"></a></p><h2>Function Overloads</h2>
<p>To bind function overloads, please try the following (in order):</p><ul>
<li><code>py::overload_cast&lt;Args&gt;(func)</code>: See <a href="http://pybind11.readthedocs.io/en/stable/classes.html#overloaded-methods">the pybind11 documentation</a>. This works about 80% of the time.</li>
<li><code><a class="el" href="namespacedrake_1_1pydrake.html#a3001fa4c52ff2d0f13a58523f67be8e0" title="Provides option to provide explicit signature when py::overload_cast&lt;Args...&gt; fails to infer the Retu...">pydrake::overload_cast_explicit</a>&lt;Return, Args...&gt;(func)</code>: When <code>py::overload_cast</code> does not work (not always guaranteed to work).</li>
<li><code>static_cast</code>, as mentioned in the <a class="el" href="namespacepybind11.html">pybind11</a> documentation.</li>
<li>Lambdas, e.g. <code>[](Args... args) -&gt; auto&amp;&amp; { return func(args...); }</code> (using perfect forwarding when appropriate).</li>
</ul>
<h2>Python Subclassing of C++ Classes</h2>
<p>In general, minimize the amount in which users may subclass C++ classes in Python. When you do wish to do this, ensure that you use a trampoline class in <code>pybind</code>, and ensure that the trampoline class inherits from the <code>py::wrapper&lt;&gt;</code> class specific to our fork of <code>pybind</code>. This ensures that no slicing happens with the subclassed instances.</p>
<h2>Convenience aliases</h2>
<p>Some aliases are provided; prefer these to the full spellings.</p>
<p><code>namespace py</code> is a shorthand alias to <code><a class="el" href="namespacepybind11.html">pybind11</a></code> for consistency.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="namespacedrake_1_1pydrake.html#ae9bdc6aba9aad5daab1513b39d2b34e7" title="Used when returning T&amp; orconst T&amp;`, as pybind&#39;s default behavior is to copy lvalue references. ">py_reference</a>, <a class="el" href="namespacedrake_1_1pydrake.html#a36e8cda2005c97af6a36240c45e67dd7" title="Used when returning references to objects that are internally owned by self. ">py_reference_internal</a> for dealing with common ownership issues.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>Downstream users should avoid <code>using namespace <a class="el" href="namespacedrake_1_1pydrake.html">drake::pydrake</a></code>, as this may create ambiguous aliases (especially for GCC). Instead, consider an alias.</dd></dl>
<p><a class="anchor" id="PydrakeBazelDebug"></a></p><h1>Interactive Debugging with Bazel</h1>
<p>If you are debugging a unitest, first try running the test with <code>--trace=user</code> to see where the code is failing. This should cover most cases where you need to debug C++ bits. Example: </p><pre class="fragment">bazel run //bindings/pydrake/systems:py/lifetime_test -- --trace=user
</pre><p>If you need to debug futher while using Bazel, it is suggested to use <code>gdbserver</code> for simplicity. Example:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Terminal 1 - Host process.</span></div><div class="line">cd <a class="code" href="namespacedrake.html">drake</a></div><div class="line">bazel run -c dbg \</div><div class="line">    --run_under=<span class="stringliteral">&#39;gdbserver localhost:9999&#39;</span> \</div><div class="line">    <span class="comment">//bindings/pydrake/systems:py/lifetime_test -- \</span></div><div class="line"><span class="comment">    --trace=user</span></div><div class="line"></div><div class="line"><span class="preprocessor"># Terminal 2 - Client debugger.</span></div><div class="line">cd <a class="code" href="namespacedrake.html">drake</a></div><div class="line">gdb -ex <span class="stringliteral">&quot;dir ${PWD}/bazel-drake&quot;</span> \</div><div class="line">    -ex <span class="stringliteral">&quot;target remote localhost:9999&quot;</span> \</div><div class="line">    -ex <span class="stringliteral">&quot;set sysroot&quot;</span> \</div><div class="line">    -ex <span class="stringliteral">&quot;set breakpoint pending on&quot;</span></div><div class="line"><span class="preprocessor"># In the GDB terminal:</span></div><div class="line">(gdb) <span class="keywordflow">break</span> <a class="code" href="classdrake_1_1systems_1_1_simulator.html">drake::systems::Simulator&lt;double&gt;::Simulator</a></div><div class="line">(gdb) <span class="keywordflow">continue</span></div></div><!-- fragment --><p><code>set sysroot</code> is important for using <code>gdbserver</code>, <code>set breakpoint pending on</code> allows you set the breakpoints before loading <code>libdrake.so</code>, and <code>dir ...</code> adds source directories. It is also suggested that you <a href="https://stackoverflow.com/a/3176802">enable readline history</a> in <code>~/.gdbinit</code> for ease of use.</p>
<p>If using CLion, you can still connect to the <code>gdbserver</code> instance.</p>
<p>There are analogs for <code>lldb</code> / <code>lldbserver</code> but for brevity, only GDB is covered. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!--HTML footer for doxygen 1.8.13-->
<!--start footer part-->
<div id="nav-path" class="navpath"><!--id is needed for treeview function!-->
  <ul>
    <li class="footer">Generated by
    <a href="https://www.stack.nl/~dimitri/doxygen/">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a></li>
  </ul>
</div>
</body>
</html>
